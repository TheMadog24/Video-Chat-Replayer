<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>TD player example</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  
  <style type="text/css">
body {
	overflow: hidden;	
	background-color:#0e0e10;
	color: white;
}  

video, input {
    display: inline;
}
video {
	width:calc(100% - 340px);
	position: absolute;
    top: 0;
    left: 0;
}

#topBox {
	height: 50px;
	width: 340px;
	border-left: 1px solid #303032;
	border-bottom: 1px solid #303032;
	position:absolute;
	top: 0;
	right: 0;
	background-color: #1f1f23;
}


#controls {
}

#vidinput {
	position: absolute;
    top: 2px;
    right: 10px;
}

#jsoninput {
	position: absolute;
    top: 25px;
    right: 10px;
}

#vidText {
	position: absolute;
	top: 2px;
	right: 215px;
	height:25px;
	margin:0;
}
#chatText {
	position: absolute;
	top: 25px;
	right: 215px;
	height:25px;
	margin:0;
}


#chat {
    width: 340px;
    border-left: 1px solid #303032;
	border-top: 1px solid #303032;
    height: calc(100% - 50px);
    position: absolute;
    right: 0;
    bottom: 0;
	overflow-y: auto;
	background-color:#18181b;
 	font-family: "Roobert";
	color: rgb(222, 222, 227);
	font-size: 13px;
	font-weight: 400;
	line-height: 20px;
	overflow-x: hidden;
}

input {
    width: 200px;
	background-color:#2b2b2f;
}

.info {
    background-color: #0096d6;            
}

.error {
    background-color: red;
    color: white;
}
  </style>
</head>
<body>
<div id="topBox"></div>
<p id="vidText">Select Video:</p>
<p id="chatText">Select Chat:</p>
<span id="controls">
	<input id="vidinput" type="file" accept="video/*"/>
	<input id="jsoninput" type="file" accept=".json"/>
	<span id="message"></span>
</span>
<video controls autoplay></video>
<span id="chat"></span>

<script type="text/javascript">//<![CDATA[
(
function localFileVideoPlayer() {
	'use strict'
	var URL = window.URL || window.webkitURL;
	var videoNode = document.querySelector('video');
	var chatNode = document.querySelector('#chat');
	var chatJson;
	
	var displayMessage = function (message, isError) {
		var element = document.querySelector('#message')
			element.innerHTML = message
			element.className = isError ? 'error' : 'info'
	}
	var playSelectedFile = function (event) {
		var file = this.files[0]
		var type = file.type
		
		var canPlay = videoNode.canPlayType(type)
		if (canPlay === '') canPlay = 'no'
		var message = 'Can play type "' + type + '": ' + canPlay
		var isError = canPlay === 'no'
		displayMessage(message, isError);

		if (isError) {
			return;
		}

		var fileURL = URL.createObjectURL(file)
		videoNode.src = fileURL
	}
	
	var loadChat = function(event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function(){
		  chatJson = JSON.parse(reader.result);
		  initChat();
		  
        };
        reader.readAsText(input.files[0]);
   };

   var updateChat = function(event) {
		if(chatJson == null) return;

		let currenTime = videoNode.currentTime;
		chatNode.innerHTML = currenTime+'<br>';
		chatJson.comments.forEach(function(obj) { 
			
			if(currenTime >= obj.content_offset_seconds) {
                let colorHex = obj.message.user_color;
                let chatLine = document.createElement('div');
                chatLine.innerHTML = '&nbsp;&nbsp;&nbsp;' + '<b style="color:' + colorHex + ';">' + obj.commenter.display_name +'</b>:'+ obj.message.body;
                chatNode.appendChild(chatLine);
            }
		});
		chatNode.scrollTop = chatNode.scrollHeight;
   }
  
  var inputNodeVideo = document.querySelector('#vidinput');
  var inputNodeChat = document.querySelector('#jsoninput');
  inputNodeVideo.addEventListener('change', playSelectedFile, false);
  inputNodeChat.addEventListener('change', loadChat, false);
  videoNode.addEventListener('timeupdate', updateChat, false);
})()
  //]]></script>
</body>
</html>

